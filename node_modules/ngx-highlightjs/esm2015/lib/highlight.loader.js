import { Injectable, Inject, PLATFORM_ID, Optional } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { BehaviorSubject, from, EMPTY, zip, throwError } from 'rxjs';
import { catchError, tap, map, switchMap, filter, take } from 'rxjs/operators';
import { HIGHLIGHT_OPTIONS } from './highlight.model';
import * as i0 from "@angular/core";
// @dynamic
export class HighlightLoader {
    constructor(doc, platformId, _options) {
        this._options = _options;
        // Stream that emits when hljs library is loaded and ready to use
        this._ready = new BehaviorSubject(null);
        this.ready = this._ready.asObservable().pipe(filter((hljs) => !!hljs), map((hljs) => hljs), take(1));
        // Check if hljs is already available
        if (isPlatformBrowser(platformId) && doc.defaultView.hljs) {
            this._ready.next(doc.defaultView.hljs);
        }
        else {
            // Load hljs library
            this._loadLibrary().pipe(switchMap((hljs) => {
                if (this._options && this._options.lineNumbersLoader) {
                    // Make hljs available on window object (required for the line numbers library)
                    doc.defaultView.hljs = hljs;
                    // Load line numbers library
                    return this.loadLineNumbers().pipe(tap(() => this._ready.next(hljs)));
                }
                else {
                    this._ready.next(hljs);
                    return EMPTY;
                }
            }), catchError((e) => {
                console.error('[HLJS] ', e);
                return EMPTY;
            })).subscribe();
        }
    }
    /**
     * Lazy-Load highlight.js library
     */
    _loadLibrary() {
        if (this._options) {
            if (this._options.fullLibraryLoader && this._options.coreLibraryLoader) {
                return throwError('The full library and the core library were imported, only one of them should be imported!');
            }
            if (this._options.fullLibraryLoader && this._options.languages) {
                return throwError('The highlighting languages were imported they are not needed!');
            }
            if (this._options.coreLibraryLoader && !this._options.languages) {
                return throwError('The highlighting languages were not imported!');
            }
            if (!this._options.coreLibraryLoader && this._options.languages) {
                return throwError('The core library was not imported!');
            }
            if (this._options.fullLibraryLoader) {
                return this.loadFullLibrary();
            }
            if (this._options.coreLibraryLoader && this._options.languages && Object.keys(this._options.languages).length) {
                return this.loadCoreLibrary().pipe(switchMap((hljs) => this._loadLanguages(hljs)));
            }
        }
        return throwError('Highlight.js library was not imported!');
    }
    /**
     * Lazy-load highlight.js languages
     */
    _loadLanguages(hljs) {
        const languages = Object.entries(this._options.languages).map(([langName, langLoader]) => importModule(langLoader()).pipe(tap((langFunc) => hljs.registerLanguage(langName, langFunc))));
        return zip(...languages).pipe(map(() => hljs));
    }
    /**
     * Import highlight.js core library
     */
    loadCoreLibrary() {
        return importModule(this._options.coreLibraryLoader());
    }
    /**
     * Import highlight.js library with all languages
     */
    loadFullLibrary() {
        return importModule(this._options.fullLibraryLoader());
    }
    /**
     * Import line numbers library
     */
    loadLineNumbers() {
        return importModule(this._options.lineNumbersLoader());
    }
}
HighlightLoader.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: HighlightLoader, deps: [{ token: DOCUMENT }, { token: PLATFORM_ID }, { token: HIGHLIGHT_OPTIONS, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
HighlightLoader.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: HighlightLoader, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: HighlightLoader, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [HIGHLIGHT_OPTIONS]
                }] }]; } });
/**
 * Map loader response to module object
 */
const importModule = (moduleLoader) => {
    return from(moduleLoader).pipe(filter((module) => !!module && !!module.default), map((module) => module.default));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmxvYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1oaWdobGlnaHRqcy9zcmMvbGliL2hpZ2hsaWdodC5sb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRSxPQUFPLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGVBQWUsRUFBYyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakYsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0UsT0FBTyxFQUFFLGlCQUFpQixFQUFzQyxNQUFNLG1CQUFtQixDQUFDOztBQUUxRixXQUFXO0FBSVgsTUFBTSxPQUFPLGVBQWU7SUFTMUIsWUFBOEIsR0FBUSxFQUNMLFVBQWtCLEVBQ1EsUUFBMEI7UUFBMUIsYUFBUSxHQUFSLFFBQVEsQ0FBa0I7UUFWckYsaUVBQWlFO1FBQ2hELFdBQU0sR0FBRyxJQUFJLGVBQWUsQ0FBMEIsSUFBSSxDQUFDLENBQUM7UUFDcEUsVUFBSyxHQUFpQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDLElBQUksQ0FDNUUsTUFBTSxDQUFDLENBQUMsSUFBNkIsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUNqRCxHQUFHLENBQUMsQ0FBQyxJQUE2QixFQUFFLEVBQUUsQ0FBQyxJQUF3QixDQUFDLEVBQ2hFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FDUixDQUFDO1FBS0EscUNBQXFDO1FBQ3JDLElBQUksaUJBQWlCLENBQUMsVUFBVSxDQUFDLElBQUksR0FBRyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUU7WUFDekQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QzthQUFNO1lBQ0wsb0JBQW9CO1lBQ3BCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQ3RCLFNBQVMsQ0FBQyxDQUFDLElBQXNCLEVBQUUsRUFBRTtnQkFDbkMsSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLEVBQUU7b0JBQ3BELCtFQUErRTtvQkFDL0UsR0FBRyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO29CQUM1Qiw0QkFBNEI7b0JBQzVCLE9BQU8sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUN2RTtxQkFBTTtvQkFDTCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDdkIsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7WUFDSCxDQUFDLENBQUMsRUFDRixVQUFVLENBQUMsQ0FBQyxDQUFNLEVBQUUsRUFBRTtnQkFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQzVCLE9BQU8sS0FBSyxDQUFDO1lBQ2YsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNmO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssWUFBWTtRQUNsQixJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLEVBQUU7Z0JBQ3RFLE9BQU8sVUFBVSxDQUFDLDJGQUEyRixDQUFDLENBQUM7YUFDaEg7WUFDRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUU7Z0JBQzlELE9BQU8sVUFBVSxDQUFDLCtEQUErRCxDQUFDLENBQUM7YUFDcEY7WUFDRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtnQkFDL0QsT0FBTyxVQUFVLENBQUMsK0NBQStDLENBQUMsQ0FBQzthQUNwRTtZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFO2dCQUMvRCxPQUFPLFVBQVUsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO2FBQ3pEO1lBQ0QsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixFQUFFO2dCQUNuQyxPQUFPLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQzthQUMvQjtZQUNELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxFQUFFO2dCQUM3RyxPQUFPLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBc0IsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDdEc7U0FDRjtRQUNELE9BQU8sVUFBVSxDQUFDLHdDQUF3QyxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVEOztPQUVHO0lBQ0ssY0FBYyxDQUFDLElBQXNCO1FBQzNDLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsRUFBRSxFQUFFLENBQ3hGLFlBQVksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FDN0IsR0FBRyxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQ2xFLENBQ0YsQ0FBQztRQUNGLE9BQU8sR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFHRDs7T0FFRztJQUNLLGVBQWU7UUFDckIsT0FBTyxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBa0IsRUFBRSxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVEOztPQUVHO0lBQ0ssZUFBZTtRQUNyQixPQUFPLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFrQixFQUFFLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBR0Q7O09BRUc7SUFDSyxlQUFlO1FBQ3JCLE9BQU8sWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQzFELENBQUM7OzRHQWpHVSxlQUFlLGtCQVNOLFFBQVEsYUFDUixXQUFXLGFBQ0MsaUJBQWlCO2dIQVh0QyxlQUFlLGNBRmQsTUFBTTsyRkFFUCxlQUFlO2tCQUgzQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7MEJBVWMsTUFBTTsyQkFBQyxRQUFROzswQkFDZixNQUFNOzJCQUFDLFdBQVc7OzBCQUNsQixRQUFROzswQkFBSSxNQUFNOzJCQUFDLGlCQUFpQjs7QUF5Rm5EOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQUcsQ0FBQyxZQUEwQixFQUFtQixFQUFFO0lBQ25FLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FDNUIsTUFBTSxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQ3JELEdBQUcsQ0FBQyxDQUFDLE1BQVcsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUNyQyxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBQTEFURk9STV9JRCwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERPQ1VNRU5ULCBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUsIGZyb20sIEVNUFRZLCB6aXAsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIHRhcCwgbWFwLCBzd2l0Y2hNYXAsIGZpbHRlciwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEhJR0hMSUdIVF9PUFRJT05TLCBIaWdobGlnaHRMaWJyYXJ5LCBIaWdobGlnaHRPcHRpb25zIH0gZnJvbSAnLi9oaWdobGlnaHQubW9kZWwnO1xuXG4vLyBAZHluYW1pY1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgSGlnaGxpZ2h0TG9hZGVyIHtcbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBobGpzIGxpYnJhcnkgaXMgbG9hZGVkIGFuZCByZWFkeSB0byB1c2VcbiAgcHJpdmF0ZSByZWFkb25seSBfcmVhZHkgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEhpZ2hsaWdodExpYnJhcnkgfCBudWxsPihudWxsKTtcbiAgcmVhZG9ubHkgcmVhZHk6IE9ic2VydmFibGU8SGlnaGxpZ2h0TGlicmFyeT4gPSB0aGlzLl9yZWFkeS5hc09ic2VydmFibGUoKS5waXBlKFxuICAgIGZpbHRlcigoaGxqczogSGlnaGxpZ2h0TGlicmFyeSB8IG51bGwpID0+ICEhaGxqcyksXG4gICAgbWFwKChobGpzOiBIaWdobGlnaHRMaWJyYXJ5IHwgbnVsbCkgPT4gaGxqcyBhcyBIaWdobGlnaHRMaWJyYXJ5KSxcbiAgICB0YWtlKDEpXG4gICk7XG5cbiAgY29uc3RydWN0b3IoQEluamVjdChET0NVTUVOVCkgZG9jOiBhbnksXG4gICAgICAgICAgICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHBsYXRmb3JtSWQ6IG9iamVjdCxcbiAgICAgICAgICAgICAgQE9wdGlvbmFsKCkgQEluamVjdChISUdITElHSFRfT1BUSU9OUykgcHJpdmF0ZSBfb3B0aW9uczogSGlnaGxpZ2h0T3B0aW9ucykge1xuICAgIC8vIENoZWNrIGlmIGhsanMgaXMgYWxyZWFkeSBhdmFpbGFibGVcbiAgICBpZiAoaXNQbGF0Zm9ybUJyb3dzZXIocGxhdGZvcm1JZCkgJiYgZG9jLmRlZmF1bHRWaWV3LmhsanMpIHtcbiAgICAgIHRoaXMuX3JlYWR5Lm5leHQoZG9jLmRlZmF1bHRWaWV3LmhsanMpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBMb2FkIGhsanMgbGlicmFyeVxuICAgICAgdGhpcy5fbG9hZExpYnJhcnkoKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKGhsanM6IEhpZ2hsaWdodExpYnJhcnkpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5fb3B0aW9ucyAmJiB0aGlzLl9vcHRpb25zLmxpbmVOdW1iZXJzTG9hZGVyKSB7XG4gICAgICAgICAgICAvLyBNYWtlIGhsanMgYXZhaWxhYmxlIG9uIHdpbmRvdyBvYmplY3QgKHJlcXVpcmVkIGZvciB0aGUgbGluZSBudW1iZXJzIGxpYnJhcnkpXG4gICAgICAgICAgICBkb2MuZGVmYXVsdFZpZXcuaGxqcyA9IGhsanM7XG4gICAgICAgICAgICAvLyBMb2FkIGxpbmUgbnVtYmVycyBsaWJyYXJ5XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5sb2FkTGluZU51bWJlcnMoKS5waXBlKHRhcCgoKSA9PiB0aGlzLl9yZWFkeS5uZXh0KGhsanMpKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3JlYWR5Lm5leHQoaGxqcyk7XG4gICAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgY2F0Y2hFcnJvcigoZTogYW55KSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignW0hMSlNdICcsIGUpO1xuICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgfSlcbiAgICAgICkuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExhenktTG9hZCBoaWdobGlnaHQuanMgbGlicmFyeVxuICAgKi9cbiAgcHJpdmF0ZSBfbG9hZExpYnJhcnkoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAodGhpcy5fb3B0aW9ucykge1xuICAgICAgaWYgKHRoaXMuX29wdGlvbnMuZnVsbExpYnJhcnlMb2FkZXIgJiYgdGhpcy5fb3B0aW9ucy5jb3JlTGlicmFyeUxvYWRlcikge1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignVGhlIGZ1bGwgbGlicmFyeSBhbmQgdGhlIGNvcmUgbGlicmFyeSB3ZXJlIGltcG9ydGVkLCBvbmx5IG9uZSBvZiB0aGVtIHNob3VsZCBiZSBpbXBvcnRlZCEnKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmZ1bGxMaWJyYXJ5TG9hZGVyICYmIHRoaXMuX29wdGlvbnMubGFuZ3VhZ2VzKSB7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdUaGUgaGlnaGxpZ2h0aW5nIGxhbmd1YWdlcyB3ZXJlIGltcG9ydGVkIHRoZXkgYXJlIG5vdCBuZWVkZWQhJyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fb3B0aW9ucy5jb3JlTGlicmFyeUxvYWRlciAmJiAhdGhpcy5fb3B0aW9ucy5sYW5ndWFnZXMpIHtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ1RoZSBoaWdobGlnaHRpbmcgbGFuZ3VhZ2VzIHdlcmUgbm90IGltcG9ydGVkIScpO1xuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLl9vcHRpb25zLmNvcmVMaWJyYXJ5TG9hZGVyICYmIHRoaXMuX29wdGlvbnMubGFuZ3VhZ2VzKSB7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdUaGUgY29yZSBsaWJyYXJ5IHdhcyBub3QgaW1wb3J0ZWQhJyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fb3B0aW9ucy5mdWxsTGlicmFyeUxvYWRlcikge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkRnVsbExpYnJhcnkoKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmNvcmVMaWJyYXJ5TG9hZGVyICYmIHRoaXMuX29wdGlvbnMubGFuZ3VhZ2VzICYmIE9iamVjdC5rZXlzKHRoaXMuX29wdGlvbnMubGFuZ3VhZ2VzKS5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZENvcmVMaWJyYXJ5KCkucGlwZShzd2l0Y2hNYXAoKGhsanM6IEhpZ2hsaWdodExpYnJhcnkpID0+IHRoaXMuX2xvYWRMYW5ndWFnZXMoaGxqcykpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRocm93RXJyb3IoJ0hpZ2hsaWdodC5qcyBsaWJyYXJ5IHdhcyBub3QgaW1wb3J0ZWQhJyk7XG4gIH1cblxuICAvKipcbiAgICogTGF6eS1sb2FkIGhpZ2hsaWdodC5qcyBsYW5ndWFnZXNcbiAgICovXG4gIHByaXZhdGUgX2xvYWRMYW5ndWFnZXMoaGxqczogSGlnaGxpZ2h0TGlicmFyeSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgbGFuZ3VhZ2VzID0gT2JqZWN0LmVudHJpZXModGhpcy5fb3B0aW9ucy5sYW5ndWFnZXMhKS5tYXAoKFtsYW5nTmFtZSwgbGFuZ0xvYWRlcl0pID0+XG4gICAgICBpbXBvcnRNb2R1bGUobGFuZ0xvYWRlcigpKS5waXBlKFxuICAgICAgICB0YXAoKGxhbmdGdW5jOiBhbnkpID0+IGhsanMucmVnaXN0ZXJMYW5ndWFnZShsYW5nTmFtZSwgbGFuZ0Z1bmMpKVxuICAgICAgKVxuICAgICk7XG4gICAgcmV0dXJuIHppcCguLi5sYW5ndWFnZXMpLnBpcGUobWFwKCgpID0+IGhsanMpKTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIEltcG9ydCBoaWdobGlnaHQuanMgY29yZSBsaWJyYXJ5XG4gICAqL1xuICBwcml2YXRlIGxvYWRDb3JlTGlicmFyeSgpOiBPYnNlcnZhYmxlPEhpZ2hsaWdodExpYnJhcnk+IHtcbiAgICByZXR1cm4gaW1wb3J0TW9kdWxlKHRoaXMuX29wdGlvbnMuY29yZUxpYnJhcnlMb2FkZXIhKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEltcG9ydCBoaWdobGlnaHQuanMgbGlicmFyeSB3aXRoIGFsbCBsYW5ndWFnZXNcbiAgICovXG4gIHByaXZhdGUgbG9hZEZ1bGxMaWJyYXJ5KCk6IE9ic2VydmFibGU8SGlnaGxpZ2h0TGlicmFyeT4ge1xuICAgIHJldHVybiBpbXBvcnRNb2R1bGUodGhpcy5fb3B0aW9ucy5mdWxsTGlicmFyeUxvYWRlciEoKSk7XG4gIH1cblxuXG4gIC8qKlxuICAgKiBJbXBvcnQgbGluZSBudW1iZXJzIGxpYnJhcnlcbiAgICovXG4gIHByaXZhdGUgbG9hZExpbmVOdW1iZXJzKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIGltcG9ydE1vZHVsZSh0aGlzLl9vcHRpb25zLmxpbmVOdW1iZXJzTG9hZGVyISgpKTtcbiAgfVxufVxuXG4vKipcbiAqIE1hcCBsb2FkZXIgcmVzcG9uc2UgdG8gbW9kdWxlIG9iamVjdFxuICovXG5jb25zdCBpbXBvcnRNb2R1bGUgPSAobW9kdWxlTG9hZGVyOiBQcm9taXNlPGFueT4pOiBPYnNlcnZhYmxlPGFueT4gPT4ge1xuICByZXR1cm4gZnJvbShtb2R1bGVMb2FkZXIpLnBpcGUoXG4gICAgZmlsdGVyKChtb2R1bGU6IGFueSkgPT4gISFtb2R1bGUgJiYgISFtb2R1bGUuZGVmYXVsdCksXG4gICAgbWFwKChtb2R1bGU6IGFueSkgPT4gbW9kdWxlLmRlZmF1bHQpXG4gICk7XG59O1xuIl19